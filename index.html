<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban Board</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #e5e5e5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }

        .input-section {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        #taskInput {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        #addTaskBtn {
            padding: 12px 24px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }

        #addTaskBtn:hover {
            background-color: #45a049;
        }

        .board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .column {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            min-height: 400px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .column-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e5e5;
        }

        .task-card {
            background-color: #f9f9f9;
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 6px;
            border-left: 4px solid #4CAF50;
            cursor: move;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            position: relative;
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        .task-card.dragging {
            opacity: 0.5;
            transform: rotate(3deg);
        }

        .task-list {
            min-height: 100px;
            transition: background-color 0.2s;
        }

        .task-list.drag-over {
            background-color: #e3f2fd;
            border-radius: 8px;
        }

        .task-text {
            color: #333;
            font-size: 15px;
            word-wrap: break-word;
            user-select: none;
        }

        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 180px;
            padding: 6px 0;
        }

        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .context-menu-item:hover {
            background-color: #f5f5f5;
        }

        .context-menu-item.delete {
            color: #f44336;
        }

        .context-menu-item.delete:hover {
            background-color: #ffebee;
        }

        @media (max-width: 768px) {
            .board {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Kanban Board</h1>

        <div class="input-section">
            <div class="input-group">
                <input type="text" id="taskInput" placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð²ÑƒÑŽ Ð·Ð°Ð´Ð°Ñ‡Ñƒ...">
                <button id="addTaskBtn">Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ</button>
            </div>
        </div>

        <div class="board">
            <div class="column">
                <div class="column-title">To Do</div>
                <div id="todo" class="task-list"></div>
            </div>

            <div class="column">
                <div class="column-title">In Progress</div>
                <div id="inProgress" class="task-list"></div>
            </div>

            <div class="column">
                <div class="column-title">Done</div>
                <div id="done" class="task-list"></div>
            </div>
        </div>
    </div>

    <script>
        const taskInput = document.getElementById('taskInput');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const todoList = document.getElementById('todo');
        const inProgressList = document.getElementById('inProgress');
        const doneList = document.getElementById('done');

        let draggedElement = null;
        let isSyncing = false;
        let contextMenu = null;

        // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Supabase ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð½Ð¾Ð³Ð¾ Ð¼ÐµÐ½ÑŽ
        function createContextMenu(x, y, taskCard) {
            // Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰ÐµÐµ Ð¼ÐµÐ½ÑŽ ÐµÑÐ»Ð¸ Ð¾Ð½Ð¾ ÐµÑÑ‚ÑŒ
            if (contextMenu) {
                contextMenu.remove();
            }

            contextMenu = document.createElement('div');
            contextMenu.className = 'context-menu';
            contextMenu.style.left = x + 'px';
            contextMenu.style.top = y + 'px';

            const currentParent = taskCard.parentElement;
            const taskText = taskCard.querySelector('.task-text').textContent;

            // ÐžÐ¿Ñ†Ð¸Ñ: ÐŸÐµÑ€ÐµÐ´Ð²Ð¸Ð½ÑƒÑ‚ÑŒ Ð²Ð»ÐµÐ²Ð¾
            if (currentParent !== todoList) {
                const moveLeftItem = document.createElement('div');
                moveLeftItem.className = 'context-menu-item';
                moveLeftItem.innerHTML = 'â† ÐŸÐµÑ€ÐµÐ´Ð²Ð¸Ð½ÑƒÑ‚ÑŒ Ð²Ð»ÐµÐ²Ð¾';
                moveLeftItem.onclick = async () => {
                    if (currentParent === inProgressList) {
                        todoList.appendChild(taskCard);
                    } else if (currentParent === doneList) {
                        inProgressList.appendChild(taskCard);
                    }
                    await syncAllTasks();
                    contextMenu.remove();
                };
                contextMenu.appendChild(moveLeftItem);
            }

            // ÐžÐ¿Ñ†Ð¸Ñ: ÐŸÐµÑ€ÐµÐ´Ð²Ð¸Ð½ÑƒÑ‚ÑŒ Ð²Ð¿Ñ€Ð°Ð²Ð¾
            if (currentParent !== doneList) {
                const moveRightItem = document.createElement('div');
                moveRightItem.className = 'context-menu-item';
                moveRightItem.innerHTML = 'ÐŸÐµÑ€ÐµÐ´Ð²Ð¸Ð½ÑƒÑ‚ÑŒ Ð²Ð¿Ñ€Ð°Ð²Ð¾ â†’';
                moveRightItem.onclick = async () => {
                    if (currentParent === todoList) {
                        inProgressList.appendChild(taskCard);
                    } else if (currentParent === inProgressList) {
                        doneList.appendChild(taskCard);
                    }
                    await syncAllTasks();
                    contextMenu.remove();
                };
                contextMenu.appendChild(moveRightItem);
            }

            // ÐžÐ¿Ñ†Ð¸Ñ: Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ
            const deleteItem = document.createElement('div');
            deleteItem.className = 'context-menu-item delete';
            deleteItem.innerHTML = 'ðŸ—‘ Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ';
            deleteItem.onclick = async () => {
                if (confirm('Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð·Ð°Ð´Ð°Ñ‡Ñƒ "' + taskText + '"?')) {
                    await deleteTaskFromSupabase(taskCard.dataset.id);
                    taskCard.remove();
                }
                contextMenu.remove();
            };
            contextMenu.appendChild(deleteItem);

            document.body.appendChild(contextMenu);
        }

        // Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ð¼ÐµÐ½ÑŽ Ð¿Ñ€Ð¸ ÐºÐ»Ð¸ÐºÐµ Ð²Ð½Ðµ ÐµÐ³Ð¾
        document.addEventListener('click', () => {
            if (contextMenu) {
                contextMenu.remove();
                contextMenu = null;
            }
        });

        // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Supabase
        async function saveTaskToSupabase(taskId, text, status, position) {
            try {
                const { data, error } = await supabase
                    .from('tasks')
                    .upsert({
                        id: taskId,
                        text: text,
                        status: status,
                        position: position
                    });

                if (error) throw error;
            } catch (error) {
                console.error('Error saving task:', error);
                alert('ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð·Ð°Ð´Ð°Ñ‡Ð¸: ' + error.message);
            }
        }

        async function deleteTaskFromSupabase(taskId) {
            try {
                const { error } = await supabase
                    .from('tasks')
                    .delete()
                    .eq('id', taskId);

                if (error) throw error;
            } catch (error) {
                console.error('Error deleting task:', error);
                alert('ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ Ð·Ð°Ð´Ð°Ñ‡Ð¸: ' + error.message);
            }
        }

        async function syncAllTasks() {
            try {
                isSyncing = true;
                const allTasks = [];

                todoList.querySelectorAll('.task-card').forEach((card, index) => {
                    allTasks.push({
                        id: card.dataset.id,
                        text: card.querySelector('.task-text').textContent,
                        status: 'todo',
                        position: index
                    });
                });

                inProgressList.querySelectorAll('.task-card').forEach((card, index) => {
                    allTasks.push({
                        id: card.dataset.id,
                        text: card.querySelector('.task-text').textContent,
                        status: 'inProgress',
                        position: index
                    });
                });

                doneList.querySelectorAll('.task-card').forEach((card, index) => {
                    allTasks.push({
                        id: card.dataset.id,
                        text: card.querySelector('.task-text').textContent,
                        status: 'done',
                        position: index
                    });
                });

                if (allTasks.length > 0) {
                    const { error } = await supabase
                        .from('tasks')
                        .upsert(allTasks, { onConflict: 'id' });

                    if (error) throw error;
                }

            } catch (error) {
                console.error('Error syncing tasks:', error);
            } finally {
                isSyncing = false;
            }
        }

        async function loadTasks() {
            try {
                const { data: tasks, error } = await supabase
                    .from('tasks')
                    .select('*')
                    .order('position', { ascending: true });

                if (error) throw error;

                if (!tasks || tasks.length === 0) {
                    // Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ñ‹ Ð·Ð°Ð´Ð°Ñ‡ ÐµÑÐ»Ð¸ Ð‘Ð” Ð¿ÑƒÑÑ‚Ð°Ñ
                    await loadExampleTasks();
                    return;
                }

                // Ð“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ð¿Ð¾ ÑÑ‚Ð°Ñ‚ÑƒÑÑƒ
                tasks.forEach(task => {
                    const taskCard = createTaskCard(task.text, task.id);

                    if (task.status === 'todo') {
                        todoList.appendChild(taskCard);
                    } else if (task.status === 'inProgress') {
                        inProgressList.appendChild(taskCard);
                    } else if (task.status === 'done') {
                        doneList.appendChild(taskCard);
                    }
                });
            } catch (error) {
                console.error('Error loading tasks:', error);
                alert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð·Ð°Ð´Ð°Ñ‡: ' + error.message);
            }
        }

        async function loadExampleTasks() {
            const exampleTasks = [
                { text: 'Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð´Ð¸Ð·Ð°Ð¹Ð½ Ð¼Ð°ÐºÐµÑ‚', status: 'todo', position: 0 },
                { text: 'ÐÐ°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸ÑŽ', status: 'todo', position: 1 },
                { text: 'ÐŸÑ€Ð¾Ð²ÐµÑÑ‚Ð¸ ÐºÐ¾Ð´-Ñ€ÐµÐ²ÑŒÑŽ', status: 'todo', position: 2 }
            ];

            for (const task of exampleTasks) {
                const taskId = crypto.randomUUID();
                const taskCard = createTaskCard(task.text, taskId);
                todoList.appendChild(taskCard);
                await saveTaskToSupabase(taskId, task.text, task.status, task.position);
            }
        }

        function setupDragAndDrop(taskCard) {
            taskCard.ondragstart = function(e) {
                if (isSyncing) {
                    e.preventDefault();
                    return false;
                }
                draggedElement = taskCard;
                taskCard.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', '');
            };

            taskCard.ondragend = function(e) {
                taskCard.classList.remove('dragging');
                document.querySelectorAll('.task-list').forEach(list => {
                    list.classList.remove('drag-over');
                });
            };

            taskCard.draggable = true;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            if (e.target.classList.contains('task-list')) {
                this.classList.remove('drag-over');
            }
        }

        async function handleDrop(e) {
            e.stopPropagation();
            e.preventDefault();

            if (draggedElement) {
                let targetList = this.classList.contains('task-list')
                    ? this
                    : this.closest('.task-list');

                if (targetList && draggedElement.parentElement !== targetList) {
                    targetList.appendChild(draggedElement);
                    await syncAllTasks();
                }
            }

            return false;
        }

        function createTaskCard(text, id = null) {
            const taskCard = document.createElement('div');
            taskCard.className = 'task-card';
            taskCard.dataset.id = id !== null ? id : crypto.randomUUID();
            taskCard.draggable = true;

            const taskText = document.createElement('div');
            taskText.className = 'task-text';
            taskText.textContent = text;

            // ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ Ð¿Ð¾ Ð¿Ñ€Ð°Ð²Ð¾Ð¹ ÐºÐ½Ð¾Ð¿ÐºÐµ Ð¼Ñ‹ÑˆÐ¸
            taskCard.oncontextmenu = (e) => {
                e.preventDefault();
                e.stopPropagation();
                createContextMenu(e.pageX, e.pageY, taskCard);
            };

            taskCard.appendChild(taskText);

            setupDragAndDrop(taskCard);

            return taskCard;
        }

        async function addTask() {
            const text = taskInput.value.trim();
            if (text === '') {
                alert('Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‚ÐµÐºÑÑ‚ Ð·Ð°Ð´Ð°Ñ‡Ð¸!');
                return;
            }

            const taskId = crypto.randomUUID();
            const taskCard = createTaskCard(text, taskId);
            todoList.appendChild(taskCard);
            taskInput.value = '';
            taskInput.focus();

            const position = todoList.querySelectorAll('.task-card').length - 1;
            await saveTaskToSupabase(taskId, text, 'todo', position);
        }

        addTaskBtn.addEventListener('click', addTask);

        taskInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addTask();
            }
        });

        // ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° drag and drop Ð´Ð»Ñ ÐºÐ¾Ð»Ð¾Ð½Ð¾Ðº
        const taskLists = [todoList, inProgressList, doneList];
        taskLists.forEach(list => {
            list.addEventListener('dragover', handleDragOver);
            list.addEventListener('dragenter', handleDragEnter);
            list.addEventListener('dragleave', handleDragLeave);
            list.addEventListener('drop', handleDrop);
        });

        // Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹
        window.addEventListener('DOMContentLoaded', async () => {
            await loadTasks();
        });
    </script>
</body>
</html>
